{% extends "base.html" %}

{% block title %}{{ hotel.name }} - Hotel Details{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Ghi ƒë√® padding c·ªßa Base v√¨ trang n√†y kh√¥ng c√≥ thanh Search Bar */
        body {
            background-color: #f0f2f5;
            padding-top: 100px !important; /* ƒêi·ªÅu ch·ªânh l·∫°i kho·∫£ng c√°ch v·ªõi Header */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Carousel Styles */
        .hotel-carousel {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .carousel-item img {
            height: 450px;
            object-fit: cover;
            width: 100%;
        }

        /* Section Styling */
        .content-card {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
            padding-left: 10px;
        }

        /* Sidebar Sticky */
        .sidebar-sticky {
            position: sticky;
            top: 100px; /* ƒêi·ªÅu ch·ªânh l·∫°i top khi cu·ªôn v√¨ header th·∫•p h∆°n */
            z-index: 90;
        }

        /* Nearby Places List */
        .nearby-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .nearby-item:last-child { border-bottom: none; }
        .nearby-thumb {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
        }
        
        /* Amenities Accordion */
        .accordion-button:not(.collapsed) {
            color: #007bff;
            background-color: #e7f1ff;
        }
        .amenity-badge {
            font-size: 0.75rem;
            margin-left: 5px;
        }

        /* Rating & Price */
        .price-box {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        /* Excluded Amenities */
        .excluded-item {
            color: #dc3545;
            font-size: 0.9rem;
        }
        
        /* --- LIGMASTAY PREMIUM CHATBOT (MAX SIZE & CENTER FIX) --- */
    
        /* N√∫t tr√≤n m·ªü chat */
        #chatToggleBtn {
            position: fixed; bottom: 30px; right: 30px; 
            width: 65px; height: 65px;
            border-radius: 50%; 
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: white; border: none;
            z-index: 1040; /* Cao h∆°n navbar m·∫∑c ƒë·ªãnh c·ªßa BS5 */
            font-size: 26px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        #chatToggleBtn:hover { transform: scale(1.1) rotate(15deg); box-shadow: 0 15px 35px rgba(0,0,0,0.4); }

        /* Khung Chat M·∫∑c ƒê·ªãnh */
        #aiChatBox {
            display: none; 
            position: fixed; 
            bottom: 110px; right: 30px;
            width: 380px; height: 600px; 
            background: #fff; 
            border-radius: 24px;
            z-index: 1050; /* C·ª±c cao ƒë·ªÉ ƒë√® m·ªçi th·ª© */
            flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* === TR·∫†NG TH√ÅI M·ªû R·ªòNG (MAX SIZE & CENTERED) === */
        #aiChatBox.expanded {
            /* K√≠ch th∆∞·ªõc "Kh·ªïng l·ªì" */
            width: 90vw;  /* 90% chi·ªÅu ngang m√†n h√¨nh */
            height: 85vh; /* 85% chi·ªÅu cao m√†n h√¨nh */
            
            /* CƒÉn gi·ªØa m√†n h√¨nh tuy·ªát ƒë·ªëi */
            bottom: 50% !important; 
            right: 50% !important;
            transform: translate(50%, 50%) !important;
            
            border-radius: 24px;
            
            /* Hi·ªáu ·ª©ng l√†m t·ªëi n·ªÅn (Backdrop) b·∫±ng Box Shadow kh·ªïng l·ªì */
            box-shadow: 0 10px 50px rgba(0,0,0,0.2), 0 0 0 100vmax rgba(0, 0, 0, 0.6);
            z-index: 9999; /* ƒê√® l√™n t·∫•t c·∫£, k·ªÉ c·∫£ modal hay navbar */
        }

        /* Header Chat */
        .chat-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 18px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex; justify-content: space-between; align-items: center;
            position: absolute; top: 0; left: 0; width: 100%; z-index: 20;
        }

        /* N·ªôi dung tin nh·∫Øn */
        #chatContent {
            flex: 1; 
            padding: 90px 25px 100px 25px; /* Padding ƒë·ªÉ n·ªôi dung kh√¥ng b·ªã che b·ªüi header/input */
            overflow-y: auto; 
            display: flex; flex-direction: column;
            background: #f8f9fc;
            scroll-behavior: smooth;
        }

        /* Bong b√≥ng Chat User */
        .msg-user { 
            align-self: flex-end; 
            background: #000; color: white; 
            padding: 14px 20px; 
            border-radius: 20px 20px 4px 20px; 
            max-width: 75%; margin-bottom: 20px; font-size: 1rem; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: slideInRight 0.3s ease-out;
            line-height: 1.5;
        }

        /* Bong b√≥ng Chat Bot */
        .msg-bot { 
            align-self: flex-start; 
            background: #fff; color: #1e293b; 
            padding: 18px; 
            border-radius: 20px 20px 20px 4px; 
            max-width: 85%; margin-bottom: 20px; font-size: 1rem; 
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            animation: slideInLeft 0.3s ease-out;
            line-height: 1.6;
        }

        /* V√πng nh·∫≠p li·ªáu (Floating) */
        .chat-input-area {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 25px;
            background: linear-gradient(to top, rgba(255,255,255,1) 85%, rgba(255,255,255,0));
            z-index: 20;
            display: flex; justify-content: center; /* CƒÉn gi·ªØa input khi m·ªü r·ªông */
        }
        
        .input-wrapper {
            background: white; border-radius: 50px;
            display: flex; align-items: center;
            padding: 6px 6px 6px 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            transition: 0.3s;
            width: 100%; max-width: 900px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông input khi full screen cho ƒë·∫πp */
        }
        .input-wrapper:focus-within { border-color: #000; transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        
        #chatInput { border: none; background: transparent; flex: 1; outline: none; font-size: 1rem; padding: 12px 0; }
        #sendChatBtn {
            width: 50px; height: 50px; border-radius: 50%; background: #000; color: white; border: none;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        #sendChatBtn:hover { transform: scale(1.1); background: #333; }

        /* Th·∫ª kh√°ch s·∫°n nh·ªè */
        .mini-hotel-card {
            display: flex; background: white; border-radius: 16px; overflow: hidden;
            border: 1px solid #f1f5f9; margin-top: 15px; transition: 0.2s; text-decoration: none; color: inherit;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .mini-hotel-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: #000; }
        .mini-img { width: 120px; height: 120px; object-fit: cover; } /* ·∫¢nh to h∆°n */
        .mini-info { padding: 15px 20px; display: flex; flex-direction: column; justify-content: center; width: calc(100% - 120px); }
        .mini-name { font-size: 1rem; font-weight: 800; line-height: 1.3; margin-bottom: 6px; }

        /* Animations */
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background-color: #adb5bd; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- TRIP GENIE STYLES (NEW) --- */
        .genie-card {
            background: linear-gradient(135deg, #000 0%, #2c3e50 100%);
            color: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        /* Hi·ªáu ·ª©ng n·ªÅn l·∫•p l√°nh nh·∫π */
        .genie-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .genie-content { position: relative; z-index: 2; }
        .btn-genie {
            background: white; color: black; border: none; font-weight: 800;
            padding: 12px 30px; border-radius: 50px; transition: all 0.3s;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }
        .btn-genie:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(255,255,255,0.5); }

        /* Timeline Design */
        .itinerary-timeline { position: relative; padding-left: 30px; margin-top: 20px; border-left: 2px dashed rgba(255,255,255,0.3); }
        .timeline-item { position: relative; margin-bottom: 25px; padding-left: 15px; animation: slideInUp 0.5s ease-out; }
        .timeline-dot {
            position: absolute; left: -36px; top: 0;
            width: 14px; height: 14px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(255,255,255,0.2);
        }
        .time-badge { font-size: 0.75rem; font-weight: 700; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .activity-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
        .activity-desc { font-size: 0.9rem; opacity: 0.9; font-weight: 300; }
    </style>
{% endblock %}

{# --- QUAN TR·ªåNG: Ghi ƒë√® block search_bar b·∫±ng r·ªóng ƒë·ªÉ ·∫©n form --- #}
{% block search_bar %}{% endblock %}

{% block content %}
    <div class="container pb-5">
        <div class="mb-3">
            <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="fas fa-arrow-left"></i> Quay l·∫°i danh s√°ch
            </a>
        </div>

        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% else %}

        <div class="d-flex justify-content-between align-items-end mb-3">
            <div>
                <h1 class="fw-bold mb-1">{{ hotel.name }}</h1>
                <p class="text-muted mb-0"><i class="fas fa-map-marker-alt text-danger"></i> {{ hotel.address }}</p>
                <div class="text-warning mt-1">
                    {% for i in range(5) %}
                        {% if i < (hotel.overall_rating|int if hotel.overall_rating else 0) %}
                            <i class="fas fa-star"></i>
                        {% else %}
                            <i class="far fa-star"></i>
                        {% endif %}
                    {% endfor %}
                    <span class="text-dark fw-bold ms-2">{{ hotel.overall_rating }}/5</span>
                    <span class="text-muted small">({{ hotel.reviews }} reviews)</span>
                </div>
            </div>
        </div>

        {% if hotel.images %}
        <div id="hotelCarousel" class="carousel slide hotel-carousel" data-bs-ride="carousel">
            <div class="carousel-inner">
                {% for img in hotel.images %}
                <div class="carousel-item {{ 'active' if loop.first }}">
                    <img src="{{ img.original_image }}" class="d-block w-100" referrerpolicy="no-referrer" alt="Hotel Image">
                </div>
                {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#hotelCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#hotelCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
            </button>
        </div>
        {% endif %}

        <div class="row">
            <div id="matchReasonBox" class="alert d-flex align-items-center border-0 mt-2 py-2 
                {{ 'bg-success bg-opacity-10' if match_reason else 'bg-light' }}" 
                style="{{ 'display: block;' if match_reason else 'display: none;' }}">
                
                <div id="matchLoading" class="w-100" style="{{ 'display: none;' if match_reason else 'display: block;' }}">
                    <small class="text-muted fw-bold">
                        <i class="fas fa-circle-notch fa-spin text-primary"></i> AI ƒëang ph√¢n t√≠ch ƒë·ªô ph√π h·ª£p...
                    </small>
                </div>

                <div id="matchContent" class="d-flex align-items-center w-100" 
                    style="{{ 'display: flex;' if match_reason else 'display: none;' }}">
                    
                    {% if match_reason %}
                        {% set parts = match_reason.split('|') %}
                        <span class="badge bg-success me-2 fs-6" id="matchScore">
                            {{ parts[0] if parts|length > 0 else '??' }}% MATCH
                        </span>
                        <small class="fw-bold text-success-emphasis" id="matchText">
                            {{ parts[1] if parts|length > 1 else match_reason }}
                        </small>
                    {% else %}
                        <span class="badge bg-success me-2 fs-6" id="matchScore"></span>
                        <small class="fw-bold text-success-emphasis" id="matchText"></small>
                    {% endif %}
                </div>
            </div>  

            <div class="col-lg-8">
                
                <div class="content-card position-relative">
                    <div class="d-flex justify-content-between align-items-start mb-3 border-bottom pb-2">
                        <h3 class="section-title mb-0 border-0 p-0">Gi·ªõi thi·ªáu</h3>
                    </div>

                    <div class="description-content">
                        <p class="lead" style="font-size: 1.05rem; line-height: 1.6;">
                            {{ hotel.description if hotel.description else 'Hi·ªán ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt cho kh√°ch s·∫°n n√†y.' }}
                            <div id="aiSummaryBox" class="mt-4 p-3 rounded-3 border-0 bg-light" style="display: none;">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-magic text-primary me-2"></i>
                                    <h6 class="fw-bold mb-0 text-primary">T√≥m t·∫Øt ƒë√°nh gi√° t·ª´ c·ªông ƒë·ªìng (AI)</h6>
                                </div>
                                <div id="aiSummaryContent" class="text-dark small" style="line-height: 1.6;">
                                    <i class="fas fa-spinner fa-spin text-muted"></i> ƒêang ph√¢n t√≠ch √Ω ki·∫øn kh√°ch h√†ng...
                                </div>
                            </div>
                        </p>
                    </div>
                    
                    {% if hotel.sustainability %}
                    <div class="alert alert-success d-flex align-items-center mt-4 rounded-3 border-0 bg-opacity-10 bg-success text-success">
                        <i class="fas fa-leaf fa-2x me-3"></i>
                        <div>
                            <strong class="text-dark">Du l·ªãch b·ªÅn v·ªØng</strong><br>
                            <small>Kh√°ch s·∫°n n√†y c√≥ c√°c bi·ªán ph√°p ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng v√† gi·∫£m r√°c th·∫£i.</small>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- === TRIP GENIE SECTION (NEW FEATURE) === -->
                <div class="genie-card" id="tripGenieSection">
                    <div class="genie-content text-center" id="genieIntro">
                        <div class="mb-3">
                            <i class="fas fa-magic fa-3x text-warning animate__animated animate__pulse animate__infinite"></i>
                        </div>
                        <h3 class="fw-bold mb-2">Trip Genie AI üßû‚Äç‚ôÇÔ∏è</h3>
                        <p class="mb-4 opacity-75">
                            {% if session.get('user_id') %}
                                D·ª±a tr√™n s·ªü th√≠ch <strong>{{ user.preferences_dict.vibe | default('Adventure') | upper }}</strong> c·ªßa b·∫°n, 
                                AI s·∫Ω thi·∫øt k·∫ø l·ªãch tr√¨nh 1 ng√†y ho√†n h·∫£o quanh kh√°ch s·∫°n n√†y.
                            {% else %}
                                ƒêƒÉng nh·∫≠p ƒë·ªÉ AI thi·∫øt k·∫ø l·ªãch tr√¨nh theo gu ri√™ng c·ªßa b·∫°n.
                            {% endif %}
                        </p>
                        
                        {% if session.get('user_id') %}
                            <button onclick="activateGenie()" class="btn-genie">
                                <i class="fas fa-wand-magic-sparkles me-2"></i> L·∫≠p l·ªãch tr√¨nh ngay
                            </button>
                        {% else %}
                            <button onclick="openAuthModal('login')" class="btn-genie">
                                ƒêƒÉng nh·∫≠p ƒë·ªÉ d√πng th·ª≠
                            </button>
                        {% endif %}
                    </div>

                    <!-- Loading State -->
                    <div id="genieLoading" class="text-center py-4" style="display: none; position: relative; z-index: 2;">
                        <div class="spinner-border text-light mb-3" role="status"></div>
                        <h5 class="fw-bold animate__animated animate__fadeIn">ƒêang tri·ªáu h·ªìi Genie...</h5>
                        <p class="small opacity-75">ƒêang qu√©t c√°c ƒë·ªãa ƒëi·ªÉm th√∫ v·ªã g·∫ßn {{ hotel.name }}...</p>
                    </div>

                    <!-- Result Area -->
                    <div id="genieResult" style="display: none; position: relative; z-index: 2;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold mb-0"><i class="fas fa-map-signs me-2"></i> L·ªãch tr√¨nh g·ª£i √Ω</h5>
                            <button onclick="resetGenie()" class="btn btn-sm btn-outline-light rounded-pill"><i class="fas fa-redo"></i> T·∫°o l·∫°i</button>
                        </div>
                        
                        <div class="itinerary-timeline" id="timelineContent">
                            <!-- JS s·∫Ω ƒëi·ªÅn n·ªôi dung v√†o ƒë√¢y -->
                        </div>
                        
                        <div class="mt-3 text-center">
                            <small class="opacity-50 fst-italic">ƒê∆∞·ª£c t·∫°o b·ªüi AI d·ª±a tr√™n v·ªã tr√≠ & s·ªü th√≠ch c·ªßa b·∫°n.</small>
                        </div>
                    </div>
                </div>
                <!-- === END TRIP GENIE SECTION === -->

                {% if hotel.amenities_detailed and hotel.amenities_detailed.groups %}
                <div class="content-card">
                    <h3 class="section-title">Ti·ªán nghi chi ti·∫øt</h3>
                    <div class="accordion" id="amenitiesAccordion">
                        {% for group in hotel.amenities_detailed.groups %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                <button class="accordion-button {{ 'collapsed' if not loop.first }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                    <strong>{{ group.title }}</strong>
                                </button>
                            </h2>
                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {{ 'show' if loop.first }}" data-bs-parent="#amenitiesAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        {% for item in group.list %}
                                        <div class="col-md-6 mb-2">
                                            {% if item.available %}
                                                <i class="fas fa-check text-success me-2"></i> {{ item.title }}
                                                {% if item.label %}
                                                    <span class="badge bg-secondary amenity-badge">{{ item.label }}</span>
                                                {% endif %}
                                            {% else %}
                                                <i class="fas fa-times text-danger me-2"></i> <span class="text-decoration-line-through text-muted">{{ item.title }}</span>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if hotel.health_and_safety %}
                <div class="content-card">
                    <h3 class="section-title"><i class="fas fa-shield-virus text-primary"></i> S·ª©c kh·ªèe & An to√†n</h3>
                    <div class="row">
                        {% for group in hotel.health_and_safety.groups %}
                        <div class="col-12 mb-3">
                            <h6 class="fw-bold">{{ group.title }}</h6>
                            <ul class="list-unstyled">
                                {% for item in group.list %}
                                    <li class="mb-1"><i class="fas fa-check-circle text-info me-2"></i>{{ item.title }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if hotel.reviews_breakdown %}
                <div class="content-card">
                    <h3 class="section-title">ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h3>
                    <div class="row">
                        {% for topic in hotel.reviews_breakdown %}
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>{{ topic.name }}</strong>
                                <span class="badge bg-light text-dark border">{{ topic.total_mentioned }} mentions</span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                {% set total = topic.positive + topic.negative + topic.neutral %}
                                {% set pos_pct = (topic.positive / total * 100) if total > 0 else 0 %}
                                {% set neg_pct = (topic.negative / total * 100) if total > 0 else 0 %}
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ pos_pct }}%"></div>
                                <div class="progress-bar bg-danger" role="progressbar" style="width: {{ neg_pct }}%"></div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-1">
                                <span><i class="fas fa-smile text-success"></i> {{ topic.positive }}</span>
                                <span><i class="fas fa-frown text-danger"></i> {{ topic.negative }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="content-card mt-4">
                    <h3 class="section-title"><i class="fas fa-comments text-primary"></i> ƒê√°nh gi√° t·ª´ c·ªông ƒë·ªìng</h3>
                    
                    <!-- Form vi·∫øt ƒë√°nh gi√° -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h5>
                            <form action="{{ url_for('hotel.add_review') }}" method="POST">
                                <input type="hidden" name="property_token" value="{{ hotel.property_token }}">
                                
                                <input type="hidden" name="current_price" value="{{ hotel.rate_per_night.lowest if hotel.rate_per_night else '' }}">
                                <input type="hidden" name="check_in" value="{{ hotel.search_context.check_in if hotel.search_context else '' }}">
                                <input type="hidden" name="check_out" value="{{ hotel.search_context.check_out if hotel.search_context else '' }}">

                                <div class="mb-3">
                                    <label class="form-label fw-bold">B·∫°n ch·∫•m m·∫•y sao?</label>
                                    <div class="rating-input">
                                        <div class="btn-group" role="group">
                                            {% for i in range(1, 6) %}
                                            <input type="radio" class="btn-check" name="rating" id="star{{i}}" value="{{i}}" required>
                                            <label class="btn btn-outline-warning" for="star{{i}}">{{i}} <i class="fas fa-star"></i></label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <textarea name="comment" class="form-control" rows="3" placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ kh√°ch s·∫°n n√†y..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> G·ª≠i ƒë√°nh gi√°</button>
                            </form>
                        </div>
                    </div>

                    <!-- B·ªò L·ªåC REVIEW (ƒê√£ ƒë∆∞·ª£c th√™m v√†o ƒë√¢y) -->
                    <div class="card bg-white border mb-3">
                        <div class="card-body p-3">
                            <form method="GET" action="{{ url_for('hotel.hotel_detail', property_token=hotel.property_token) }}" class="row g-2 align-items-center">
                                <input type="hidden" name="price" value="{{ hotel.rate_per_night.lowest if hotel.rate_per_night else '' }}">
                                <input type="hidden" name="check_in" value="{{ hotel.search_context.check_in if hotel.search_context else '' }}">
                                <input type="hidden" name="check_out" value="{{ hotel.search_context.check_out if hotel.search_context else '' }}">
                    
                                <div class="col-auto">
                                    <label class="fw-bold small text-muted">L·ªçc theo sao:</label>
                                </div>
                                <div class="col-auto">
                                    <select name="filter_rating" class="form-select form-select-sm">
                                        <option value="">T·∫•t c·∫£</option>
                                        <option value="5" {% if request.args.get('filter_rating') == '5' %}selected{% endif %}>5 Sao</option>
                                        <option value="4" {% if request.args.get('filter_rating') == '4' %}selected{% endif %}>4 Sao</option>
                                        <option value="3" {% if request.args.get('filter_rating') == '3' %}selected{% endif %}>3 Sao</option>
                                        <option value="2" {% if request.args.get('filter_rating') == '2' %}selected{% endif %}>2 Sao</option>
                                        <option value="1" {% if request.args.get('filter_rating') == '1' %}selected{% endif %}>1 Sao</option>
                                    </select>
                                </div>
                    
                                <div class="col-auto ms-3">
                                    <label class="fw-bold small text-muted">S·∫Øp x·∫øp:</label>
                                </div>
                                <div class="col-auto">
                                    <select name="sort_review" class="form-select form-select-sm">
                                        <option value="newest" {% if request.args.get('sort_review') == 'newest' %}selected{% endif %}>M·ªõi nh·∫•t</option>
                                        <option value="oldest" {% if request.args.get('sort_review') == 'oldest' %}selected{% endif %}>C≈© nh·∫•t</option>
                                        <option value="highest" {% if request.args.get('sort_review') == 'highest' %}selected{% endif %}>ƒêi·ªÉm cao nh·∫•t</option>
                                        <option value="lowest" {% if request.args.get('sort_review') == 'lowest' %}selected{% endif %}>ƒêi·ªÉm th·∫•p nh·∫•t</option>
                                    </select>
                                </div>
                    
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-sm btn-primary">√Åp d·ª•ng</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- K·∫æT TH√öC B·ªò L·ªåC REVIEW -->

                    <!-- Danh s√°ch Review -->
                    <div class="review-list">
                        {% if local_reviews %}
                            {% for review in local_reviews %}
                            <div class="d-flex mb-3 border-bottom pb-3">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 45px; height: 45px; font-weight: bold;">
                                        {{ review.username[0] | upper }}
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-0 fw-bold">{{ review.username }}</h6>
                                        <small class="text-muted">{{ review.created_at }}</small>
                                    </div>
                                    <div class="text-warning small mb-1">
                                        {% for i in range(review.rating) %}<i class="fas fa-star"></i>{% endfor %}
                                    </div>
                                    <p class="mb-0 text-dark">{{ review.comment }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center py-3">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o (ph√π h·ª£p v·ªõi b·ªô l·ªçc). H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="sidebar-sticky">
                    <div class="price-box mb-4 shadow">
                        <h4 class="mb-2">Gi√° m·ªói ƒë√™m</h4>
                        <div class="display-5 fw-bold mb-2">
                            {{ hotel.rate_per_night.lowest if hotel.rate_per_night else 'Li√™n h·ªá' }}
                        </div>
                        <p class="small opacity-75">ƒê√£ bao g·ªìm thu·∫ø & ph√≠ (n·∫øu c√≥)</p>
                        <a href="{{ hotel.link }}" target="_blank" class="btn btn-light text-primary w-100 fw-bold">
                            <i class="fas fa-external-link-alt"></i> ƒê·∫∑t ph√≤ng ngay
                        </a>
                        <button id="btnFavorite" onclick="toggleFavorite()" 
                                class="btn w-100 mt-2 {{ 'btn-danger' if is_favorite else 'btn-outline-danger' }}">
                            <i class="{{ 'fas' if is_favorite else 'far' }} fa-heart"></i> 
                            <span id="favText">{{ 'ƒê√£ y√™u th√≠ch' if is_favorite else 'L∆∞u y√™u th√≠ch' }}</span>
                        </button>
                    </div>

                    {% if hotel.excluded_amenities %}
                    <div class="content-card border-danger border-start border-4">
                        <h5 class="text-danger"><i class="fas fa-exclamation-circle"></i> L∆∞u √Ω kh√¥ng c√≥:</h5>
                        <ul class="list-unstyled mb-0">
                            {% for item in hotel.excluded_amenities %}
                            <li class="excluded-item mb-1"><i class="fas fa-times-circle"></i> {{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if hotel.gps_coordinates %}
                    <div class="content-card p-0 overflow-hidden">
                        <iframe 
                            width="100%" 
                            height="250" 
                            style="border:0;" 
                            loading="lazy" 
                            allowfullscreen
                            src="https://maps.google.com/maps?q={{ hotel.gps_coordinates.latitude }},{{ hotel.gps_coordinates.longitude }}&hl=vi&z=16&output=embed">
                        </iframe>
                        <div class="p-3">
                            <small class="text-muted"><i class="fas fa-map-pin"></i> {{ hotel.address }}</small>
                        </div>
                    </div>
                    {% endif %}

                    {% if hotel.nearby_places %}
                    <div class="content-card">
                        <h5 class="mb-3">ƒê·ªãa ƒëi·ªÉm xung quanh</h5>
                        <div class="nearby-list">
                            {% for place in hotel.nearby_places[:6] %}
                            <div class="nearby-item">
                                <img src="{{ place.thumbnail if place.thumbnail else 'https://via.placeholder.com/50' }}" class="nearby-thumb" alt="Place">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 small fw-bold">{{ place.name }}</h6>
                                    <div class="text-muted small" style="font-size: 0.75rem;">
                                        {% if place.transportations %}
                                            {% for trans in place.transportations %}
                                                <span class="me-2">
                                                    {% if trans.type == 'Walking' %}<i class="fas fa-walking"></i>
                                                    {% elif trans.type == 'Taxi' %}<i class="fas fa-taxi"></i>
                                                    {% else %}<i class="fas fa-bus"></i>{% endif %}
                                                    {{ trans.duration }}
                                                </span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>

        {% endif %} 
    </div>

    <button id="chatToggleBtn">
        <i class="fas fa-comment-dots"></i>
    </button>

    <div id="aiChatBox">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <div class="bg-dark text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px; font-size: 1.2rem;">
                    <i class="fas fa-robot"></i>
                </div>
                <div style="line-height: 1.2;">
                    <h6 class="mb-0 fw-bold text-dark">AI Concierge</h6>
                    <small class="text-success" style="font-size: 0.75rem;">‚óè ƒêang h·ªó tr·ª£ b·∫°n</small>
                </div>
            </div>
            <div>
                <button id="expandChatBtn" class="btn btn-sm btn-light rounded-circle me-1 text-muted" title="M·ªü r·ªông/Thu nh·ªè" style="width: 32px; height: 32px;">
                    <i class="fas fa-expand-alt"></i>
                </button>
                <button id="clearChatBtn" class="btn btn-sm btn-light rounded-circle me-1 text-muted" title="X√≥a l·ªãch s·ª≠" style="width: 32px; height: 32px;">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button id="closeChatBtn" class="btn btn-sm btn-light rounded-circle text-muted" style="width: 32px; height: 32px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div id="chatContent">
            </div>

        <div class="chat-input-area">
            <div class="input-wrapper" style="box-shadow: none; border: 1px solid #e2e8f0;">
                <input type="text" id="chatInput" placeholder="H·ªèi v·ªÅ kh√°ch s·∫°n n√†y..." autocomplete="off">
                <button id="sendChatBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        (function(){
            const chatBtn = document.getElementById('chatToggleBtn');
            const chatBox = document.getElementById('aiChatBox');
            const closeChat = document.getElementById('closeChatBtn');
            const clearChat = document.getElementById('clearChatBtn');   // M·ªõi
            const expandChat = document.getElementById('expandChatBtn'); // M·ªõi
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendChatBtn');
            const content = document.getElementById('chatContent');

            let isExpanded = false; // Tr·∫°ng th√°i m·ªü r·ªông

            // --- HI·ªÜU ·ª®NG UI M·ªû/ƒê√ìNG ---
            chatBtn.onclick = () => {
                chatBox.style.display = 'flex';
                // Animation
                setTimeout(() => {
                    chatBox.style.opacity = '1';
                    chatBox.style.transform = 'translateY(0) scale(1)';
                }, 10);
                chatBtn.style.transform = 'scale(0) rotate(180deg)'; // Hi·ªáu ·ª©ng n√∫t bi·∫øn m·∫•t
                input.focus();
            };

            function closeChatBox() {
                chatBox.style.display = 'none';
                chatBtn.style.transform = 'scale(1) rotate(0deg)';
                if(isExpanded) toggleExpand(); // Thu nh·ªè l·∫°i n·∫øu ƒëang ph√≥ng to
            }
            closeChat.onclick = closeChatBox;

            // --- LOGIC M·ªû R·ªòNG (M·ªöI) ---
            function toggleExpand() {
                isExpanded = !isExpanded;
                chatBox.classList.toggle('expanded');
                
                const icon = expandChat.querySelector('i');
                if (isExpanded) {
                    icon.classList.remove('fa-expand-alt');
                    icon.classList.add('fa-compress-alt');
                } else {
                    icon.classList.remove('fa-compress-alt');
                    icon.classList.add('fa-expand-alt');
                }
            }
            expandChat.onclick = toggleExpand;

            // --- LOGIC X√ìA CHAT (M·ªöI) ---
            clearChat.onclick = () => {
                if(confirm("X√≥a cu·ªôc h·ªôi tho·∫°i hi·ªán t·∫°i?")) {
                    content.innerHTML = '';
                    // Reset l·∫°i l·ªùi ch√†o
                    triggerProactiveGreeting();
                }
            };

            // --- H√ÄM RENDER TIN NH·∫ÆN ---
            function appendMsg(text, role) {
                const div = document.createElement('div');
                div.className = role === 'user' ? 'msg-user' : 'msg-bot';
                div.innerHTML = text; 
                content.appendChild(div);
                content.scrollTop = content.scrollHeight;
            }

            // --- LOGIC CH√ÄO CH·ª¶ ƒê·ªòNG ---
            function triggerProactiveGreeting() {
                const userVibe = "{{ user.preferences_dict.vibe if user and user.preferences_dict else '' }}";
                let greeting = "üëã Ch√†o b·∫°n! B·∫°n th·∫•y kh√°ch s·∫°n {{ hotel.name }} th·∫ø n√†o?";

                if(userVibe.includes('healing')) greeting = "üåø Kh√¥ng gian ·ªü ƒë√¢y r·∫•t y√™n tƒ©nh, b·∫°n c√≥ mu·ªën xem th√™m ·∫£nh Spa kh√¥ng?";
                else if(userVibe.includes('family')) greeting = "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ch·ªó n√†y c√≥ ph√≤ng gia ƒë√¨nh r·ªông l·∫Øm, b·∫°n c·∫ßn m√¨nh check gi√° gi∆∞·ªùng ph·ª• kh√¥ng?";
                else if(userVibe.includes('luxury')) greeting = "üíé D·ªãch v·ª• ·ªü ƒë√¢y chu·∫©n 5 sao. B·∫°n c·∫ßn h·ªó tr·ª£ ƒë·∫∑t ph√≤ng VIP ch·ª©?";

                appendMsg(`<strong>AI Concierge:</strong><br>${greeting}`, 'bot');
            }

            // G·ªçi l·ªùi ch√†o khi load trang (delay nh·∫π)
            setTimeout(() => {
                if(content.innerHTML.trim() === '') triggerProactiveGreeting();
                // T·ª± ƒë·ªông m·ªü chat sau 5s n·∫øu ch∆∞a m·ªü (nh∆∞ c≈©)
                if(chatBox.style.display === 'none' || chatBox.style.display === '') {
                    chatBox.style.display = 'flex';
                    chatBtn.style.transform = 'scale(0)';
                }
            }, 5000);

            // --- G·ª¨I TIN NH·∫ÆN ---
            async function sendMessage() {
                const text = input.value.trim();
                if(!text) return;

                appendMsg(text, 'user');
                input.value = '';

                // Loading
                const loadingId = 'loading-' + Date.now();
                const loader = document.createElement('div');
                loader.className = 'msg-bot text-muted fst-italic';
                loader.id = loadingId;
                loader.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ƒêang li√™n h·ªá l·ªÖ t√¢n AI...';
                content.appendChild(loader);
                content.scrollTop = content.scrollHeight;

                try {
                    const resp = await fetch('/api/hotel_chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: text,
                            property_token: "{{ hotel.property_token }}",
                            hotel_fallback: { name: "{{ hotel.name }}", address: "{{ hotel.address }}" },
                            dynamic_context: {
                                price: "{{ hotel.rate_per_night.lowest if hotel.rate_per_night else 'Li√™n h·ªá' }}",
                                check_in: "{{ hotel.search_context.check_in if hotel.search_context else '' }}",
                                check_out: "{{ hotel.search_context.check_out if hotel.search_context else '' }}"
                            }
                        })
                    });

                    const data = await resp.json();
                    document.getElementById(loadingId).remove();

                    if (data.reply) {
                        appendMsg(data.reply, 'bot');
                    } else {
                        appendMsg("Xin l·ªói, m√¨nh ƒëang g·∫∑p ch√∫t tr·ª•c tr·∫∑c.", 'bot');
                    }

                } catch (e) {
                    console.error(e);
                    if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                    appendMsg("L·ªói k·∫øt n·ªëi m·∫°ng.", 'bot');
                }
            }

            sendBtn.onclick = sendMessage;
            input.onkeydown = (e) => { if(e.key === 'Enter') sendMessage(); };
        })();

        document.addEventListener("DOMContentLoaded", async function() {
        {% if session.get('user_id') %}
        
        // KI·ªÇM TRA: N·∫øu Server ƒë√£ g·ª≠i match_reason xu·ªëng r·ªìi th√¨ KH√îNG l√†m g√¨ c·∫£
        // Bi·∫øn 'hasCachedReason' s·∫Ω l√† true n·∫øu match_reason kh√¥ng r·ªóng
        const hasCachedReason = {{ 'true' if match_reason else 'false' }};
        
        if (!hasCachedReason) {
            // === CH·ªà G·ªåI API KHI CH∆ØA C√ì CACHE ===
            const matchBox = document.getElementById('matchReasonBox');
            matchBox.style.display = 'block'; // Hi·ªán khung loading
            
            try {
                const resp = await fetch('/api/get_match_reason', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        property_token: "{{ hotel.property_token }}",
                        hotel_name: "{{ hotel.name }}",
                        amenities: [] 
                    })
                });
                
                const data = await resp.json();
                
                if (data.match) {
                    const parts = data.match.split('|');
                    const score = parts[0] || '??';
                    const text = parts[1] || data.match;
                    
                    document.getElementById('matchScore').innerText = `${score}% MATCH`;
                    document.getElementById('matchText').innerText = text;
                    
                    // ƒê·ªïi style t·ª´ Loading sang Success
                    matchBox.classList.remove('bg-light');
                    matchBox.classList.add('bg-success', 'bg-opacity-10');
                    
                    document.getElementById('matchLoading').style.display = 'none';
                    document.getElementById('matchContent').style.display = 'flex';
                } else {
                    matchBox.style.display = 'none';
                }
            } catch (e) {
                console.error(e);
                matchBox.style.display = 'none';
            }
        } else {
            console.log("Using cached AI match result from server.");
        }
    {% endif %}
            const summaryBox = document.getElementById('aiSummaryBox');
            const summaryContent = document.getElementById('aiSummaryContent');
            const propertyToken = "{{ hotel.property_token }}";

            if (!summaryBox) return;

            // Hi·ªÉn th·ªã box v√† tr·∫°ng th√°i loading
            summaryBox.style.display = 'block';

            try {
                const resp = await fetch('/api/summarize_reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ property_token: propertyToken })
                });

                const data = await resp.json();

                if (data.summary) {
                    // Hi·ªáu ·ª©ng g√µ ch·ªØ ho·∫∑c hi·ªán th·∫≥ng
                    summaryContent.innerHTML = data.summary;
                } else {
                    // N·∫øu kh√¥ng c√≥ review n√†o
                    summaryContent.innerHTML = '<span class="text-muted fst-italic">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o t·ª´ c·ªông ƒë·ªìng ƒë·ªÉ t√≥m t·∫Øt.</span>';
                }
            } catch (err) {
                console.error("Summary error:", err);
                summaryBox.style.display = 'none'; // ·∫®n lu√¥n n·∫øu l·ªói
            }
        });

        let isFav = {{ 'true' if is_favorite else 'false' }};
        const propertyToken = "{{ hotel.property_token }}";

        async function toggleFavorite() {
            const btn = document.getElementById('btnFavorite');
            const icon = btn.querySelector('i');
            const text = document.getElementById('favText');
            
            // 1. X√°c ƒë·ªãnh h√†nh ƒë·ªông d·ª±a tr√™n tr·∫°ng th√°i hi·ªán t·∫°i
            const url = isFav ? '/favorites/remove' : '/favorites';
            
            // D·ªØ li·ªáu g·ª≠i ƒëi (N·∫øu l√† Remove th√¨ ch·ªâ c·∫ßn token, n·∫øu Add th√¨ c·∫ßn full info)
            const payload = {
                property_token: propertyToken,
                name: "{{ hotel.name }}",
                image: "{{ hotel.images[0].original_image if hotel.images else '' }}",
                price: "{{ hotel.rate_per_night.lowest if hotel.rate_per_night else 'Li√™n h·ªá' }}",
                address: "{{ hotel.address }}"
            };

            try {
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    // 2. ƒê·∫£o ng∆∞·ª£c tr·∫°ng th√°i
                    isFav = !isFav; 

                    // 3. C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
                    if (isFav) {
                        // ƒê√£ th√≠ch: N·ªÅn ƒë·ªè, Tim ƒë·∫∑c
                        btn.classList.remove('btn-outline-danger');
                        btn.classList.add('btn-danger');
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        text.innerText = "ƒê√£ y√™u th√≠ch";
                    } else {
                        // B·ªè th√≠ch: N·ªÅn tr·∫Øng, Tim r·ªóng
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-outline-danger');
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        text.innerText = "L∆∞u y√™u th√≠ch";
                    }
                } else {
                    alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.");
                }
            } catch (e) {
                console.error(e);
                alert("L·ªói k·∫øt n·ªëi.");
            }
        }

        /* --- TRIP GENIE JS LOGIC (NEW) --- */
        async function activateGenie() {
            const intro = document.getElementById('genieIntro');
            const loading = document.getElementById('genieLoading');
            const result = document.getElementById('genieResult');
            const timeline = document.getElementById('timelineContent');
            
            // UI Transition
            intro.style.display = 'none';
            loading.style.display = 'block';
            
            try {
                const resp = await fetch('/api/generate_itinerary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        property_token: "{{ hotel.property_token }}",
                        hotel_name: "{{ hotel.name }}",
                        address: "{{ hotel.address }}"
                    })
                });
                
                const data = await resp.json();
                
                if (data.error) throw new Error(data.error);
                
                // Build HTML Timeline
                let html = '';
                const periods = [
                    { key: 'morning', label: 'Bu·ªïi S√°ng' },
                    { key: 'noon', label: 'Bu·ªïi Tr∆∞a' },
                    { key: 'afternoon', label: 'Bu·ªïi Chi·ªÅu' },
                    { key: 'evening', label: 'Bu·ªïi T·ªëi' }
                ];
                
                periods.forEach(p => {
                    if(data[p.key]) {
                        const item = data[p.key];
                        html += `
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="time-badge"><i class="far fa-clock me-1"></i> ${item.time}</div>
                                <div class="activity-title">
                                    <i class="fas ${item.icon} me-2 text-warning"></i> ${item.activity}
                                </div>
                                <div class="activity-desc">${item.desc}</div>
                            </div>
                        `;
                    }
                });
                
                timeline.innerHTML = html;
                
                // Show Result
                loading.style.display = 'none';
                result.style.display = 'block';
                result.classList.add('animate__animated', 'animate__fadeIn');
                
            } catch (e) {
                console.error(e);
                loading.style.display = 'none';
                intro.style.display = 'block';
                alert("Genie ƒëang b·∫≠n ho·∫∑c g·∫∑p l·ªói k·∫øt n·ªëi. Th·ª≠ l·∫°i sau nh√©!");
            }
        }

        function resetGenie() {
            document.getElementById('genieResult').style.display = 'none';
            document.getElementById('genieIntro').style.display = 'block';
            document.getElementById('genieIntro').classList.add('animate__animated', 'animate__fadeIn');
        }
    </script>
{% endblock %}
